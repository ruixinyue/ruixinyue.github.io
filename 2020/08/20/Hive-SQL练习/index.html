<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>Hive SQL练习 - ruixinyue</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ruixinyue</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
                Hive SQL练习
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-20 15:38">
      August 20, 2020 pm
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      49
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h2 id="1-窗口函数——练习一"><a href="#1-窗口函数——练习一" class="headerlink" title="1. 窗口函数——练习一"></a>1. 窗口函数——练习一</h2><pre><code class="hljs mysql">Function (arg1,..., argn) OVER ([PARTITION BY &lt;...&gt;] [ORDER BY &lt;....&gt;]
[&lt;window_expression&gt;])</code></pre>

<p>Function (arg1,…, argn) 可以是下面的函数：</p>
<ul>
<li>Aggregate Functions: 聚合函数,比如：sum(…)、 max(…)、min(…)、avg(…)等.</li>
<li>Sort Functions: 数据排序函数, 比如 ：rank(…)、row_number(…)等.</li>
<li>Analytics Functions: 统计和比较函数, 比如：lead(…)、lag(…)、 first_value(…)等.</li>
</ul>
<h3 id="1-1-数据准备"><a href="#1-1-数据准备" class="headerlink" title="1.1 数据准备"></a>1.1 数据准备</h3><h4 id="1-1-1-样例数据"><a href="#1-1-1-样例数据" class="headerlink" title="1.1.1 样例数据"></a>1.1.1 样例数据</h4><pre><code class="hljs angelscript">[职工姓名|部门编号|职工ID|工资|岗位类型|入职时间]

Michael|<span class="hljs-number">1000</span>|<span class="hljs-number">100</span>|<span class="hljs-number">5000</span>|full|<span class="hljs-number">2014</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>
Will|<span class="hljs-number">1000</span>|<span class="hljs-number">101</span>|<span class="hljs-number">4000</span>|full|<span class="hljs-number">2013</span><span class="hljs-number">-10</span><span class="hljs-number">-02</span>
Wendy|<span class="hljs-number">1000</span>|<span class="hljs-number">101</span>|<span class="hljs-number">4000</span>|part|<span class="hljs-number">2014</span><span class="hljs-number">-10</span><span class="hljs-number">-02</span>
Steven|<span class="hljs-number">1000</span>|<span class="hljs-number">102</span>|<span class="hljs-number">6400</span>|part|<span class="hljs-number">2012</span><span class="hljs-number">-11</span><span class="hljs-number">-03</span>
Lucy|<span class="hljs-number">1000</span>|<span class="hljs-number">103</span>|<span class="hljs-number">5500</span>|full|<span class="hljs-number">2010</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>
Lily|<span class="hljs-number">1001</span>|<span class="hljs-number">104</span>|<span class="hljs-number">5000</span>|part|<span class="hljs-number">2014</span><span class="hljs-number">-11</span><span class="hljs-number">-29</span>
Jess|<span class="hljs-number">1001</span>|<span class="hljs-number">105</span>|<span class="hljs-number">6000</span>|part|<span class="hljs-number">2014</span><span class="hljs-number">-12</span><span class="hljs-number">-02</span>
Mike|<span class="hljs-number">1001</span>|<span class="hljs-number">106</span>|<span class="hljs-number">6400</span>|part|<span class="hljs-number">2013</span><span class="hljs-number">-11</span><span class="hljs-number">-03</span>
Wei|<span class="hljs-number">1002</span>|<span class="hljs-number">107</span>|<span class="hljs-number">7000</span>|part|<span class="hljs-number">2010</span><span class="hljs-number">-04</span><span class="hljs-number">-03</span>
Yun|<span class="hljs-number">1002</span>|<span class="hljs-number">108</span>|<span class="hljs-number">5500</span>|full|<span class="hljs-number">2014</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>
Richard|<span class="hljs-number">1002</span>|<span class="hljs-number">109</span>|<span class="hljs-number">8000</span>|full|<span class="hljs-number">2013</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span></code></pre>

<h4 id="1-1-2-建表语句"><a href="#1-1-2-建表语句" class="headerlink" title="1.1.2 建表语句"></a>1.1.2 建表语句</h4><pre><code class="hljs mysql">CREATE TABLE IF NOT EXISTS employee (
                name string,
                dept_num int,
                employee_id int,
                salary int,
                type string,
                start_date date
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY &#39;|&#39;
STORED as TEXTFILE;</code></pre>

<h4 id="1-1-3-导入数据"><a href="#1-1-3-导入数据" class="headerlink" title="1.1.3 导入数据"></a>1.1.3 导入数据</h4><pre><code class="hljs mysql">load data local inpath &#39;&#x2F;opt&#x2F;datas&#x2F;data&#x2F;employee_contract.txt&#39; into table employee;</code></pre>

<h3 id="1-2-窗口聚合函数"><a href="#1-2-窗口聚合函数" class="headerlink" title="1.2 窗口聚合函数"></a>1.2 窗口聚合函数</h3><h4 id="1-2-1-查询姓名、部门编号、工资以及部门人数"><a href="#1-2-1-查询姓名、部门编号、工资以及部门人数" class="headerlink" title="1.2.1 查询姓名、部门编号、工资以及部门人数"></a>1.2.1 查询姓名、部门编号、工资以及部门人数</h4><pre><code class="hljs angelscript">select 
    name,
    dept_num as deptno ,
    salary,
    count(*) over (partition by dept_num) as cnt 
<span class="hljs-keyword">from</span> employee ;

查询结果：
name    deptno  salary  cnt
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">5</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">5</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">5</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">5</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">5</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">3</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">3</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">3</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">3</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">3</span></code></pre>

<h4 id="1-2-2-查询姓名、部门编号、工资以及每个部门的总工资，部门总工资按照降序输出"><a href="#1-2-2-查询姓名、部门编号、工资以及每个部门的总工资，部门总工资按照降序输出" class="headerlink" title="1.2.2 查询姓名、部门编号、工资以及每个部门的总工资，部门总工资按照降序输出"></a>1.2.2 查询姓名、部门编号、工资以及每个部门的总工资，部门总工资按照降序输出</h4><pre><code class="hljs angelscript">select 
    name ,
    dept_num as deptno,
    salary,
    sum(salary) over (partition by dept_num order by dept_num) as sum_dept_salary 
<span class="hljs-keyword">from</span> employee 
order by sum_dept_salary desc;

name    deptno  salary  sum_dept_salary
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">24900</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">24900</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">24900</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">24900</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">24900</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">20500</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">20500</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">20500</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">17400</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">17400</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">17400</span></code></pre>

<h3 id="1-3-窗口排序函数"><a href="#1-3-窗口排序函数" class="headerlink" title="1.3 窗口排序函数"></a>1.3 窗口排序函数</h3><p>窗口排序函数提供了数据的排序信息，比如行号和排名。在一个分组的内部将行号或者排名作为数据的一部分进行返回，最常用的排序函数主要包括：</p>
<ul>
<li><strong>row_number</strong></li>
</ul>
<p>根据具体的分组和排序，为每行数据生成一个起始值等于1的唯一序列数</p>
<ul>
<li><strong>rank</strong></li>
</ul>
<p>对组中的数据进行排名，如果名次相同，则排名也相同，但是下一个名次的排名序号会出现不连续。比如查找具体条件的topN行</p>
<ul>
<li><strong>dense_rank</strong></li>
</ul>
<p>dense_rank函数的功能与rank函数类似，dense_rank函数在生成序号时是连续的，而rank函数生成的序号有可能不连续。当出现名次相同时，则排名序号也相同。而下一个排名的序号与上一个排名序号是连续的。</p>
<ul>
<li><strong>percent_rank</strong></li>
</ul>
<p>排名计算公式为：(current rank - 1)/(total number of rows - 1)</p>
<ul>
<li><strong>ntile</strong></li>
</ul>
<p>将一个有序的数据集划分为多个桶(bucket)，并为每行分配一个适当的桶数。它可用于将数据划分为相等的小切片，为每一行分配该小切片的数字序号。</p>
<h4 id="1-3-1-查询姓名、部门编号、工资、排名编号-按工资的多少排名"><a href="#1-3-1-查询姓名、部门编号、工资、排名编号-按工资的多少排名" class="headerlink" title="1.3.1 查询姓名、部门编号、工资、排名编号(按工资的多少排名)"></a>1.3.1 查询姓名、部门编号、工资、排名编号(按工资的多少排名)</h4><pre><code class="hljs angelscript">select 
   name ,
   dept_num as dept_no ,
   salary,
   row_number() over (order by salary desc ) rnum 
<span class="hljs-keyword">from</span> employee;

name    dept_no salary  rnum
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">2</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">4</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">5</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">6</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">7</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">8</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">9</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">10</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">11</span></code></pre>

<h4 id="1-3-2-查询每个部门工资最高的两个人的信息-姓名、部门、薪水"><a href="#1-3-2-查询每个部门工资最高的两个人的信息-姓名、部门、薪水" class="headerlink" title="1.3.2 查询每个部门工资最高的两个人的信息(姓名、部门、薪水)"></a>1.3.2 查询每个部门工资最高的两个人的信息(姓名、部门、薪水)</h4><pre><code class="hljs angelscript">select 
   name,
   dept_num,
   salary 
<span class="hljs-keyword">from</span>
(
 select name ,
   dept_num ,
   salary,
   row_number() over (partition by dept_num order by salary desc ) rnum 
 <span class="hljs-keyword">from</span> employee) t1
 where rnum &lt;= <span class="hljs-number">2</span>;
 
 name    dept_num        salary
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span></code></pre>

<h4 id="1-3-3-查询每个部门的员工工资排名信息"><a href="#1-3-3-查询每个部门的员工工资排名信息" class="headerlink" title="1.3.3 查询每个部门的员工工资排名信息"></a>1.3.3 查询每个部门的员工工资排名信息</h4><pre><code class="hljs angelscript">select
 name ,
 dept_num as dept_no ,
 salary,row_number() over (partition by dept_num order by salary desc ) rnum 
<span class="hljs-keyword">from</span> employee;

name    dept_no salary  rnum
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">1</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">2</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">3</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">5</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">1</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">2</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">3</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">2</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">3</span></code></pre>

<h4 id="1-3-4-使用rank函数进行排名"><a href="#1-3-4-使用rank函数进行排名" class="headerlink" title="1.3.4 使用rank函数进行排名"></a>1.3.4 使用rank函数进行排名</h4><pre><code class="hljs angelscript">select
  name,
  dept_num,
  salary,
  rank() over (order by salary desc) rank
<span class="hljs-keyword">from</span> employee;

name    dept_num        salary  rank
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">2</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">5</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">6</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">6</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">8</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">8</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">10</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">10</span></code></pre>

<h4 id="1-3-4-使用dense-rank进行排名"><a href="#1-3-4-使用dense-rank进行排名" class="headerlink" title="1.3.4 使用dense_rank进行排名"></a>1.3.4 使用dense_rank进行排名</h4><pre><code class="hljs angelscript">select
  name,
  dept_num,
  salary,
  dense_rank() over (order by salary desc) rank
<span class="hljs-keyword">from</span> employee;

name    dept_num        salary  rank
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">2</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">3</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">4</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">5</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">5</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">6</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">6</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">7</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">7</span></code></pre>

<h4 id="1-3-5-使用percent-rank-进行排名"><a href="#1-3-5-使用percent-rank-进行排名" class="headerlink" title="1.3.5 使用percent_rank()进行排名"></a>1.3.5 使用percent_rank()进行排名</h4><pre><code class="hljs angelscript">select
  name,
  dept_num,
  salary,
  percent_rank() over (order by salary desc) rank
<span class="hljs-keyword">from</span> employee;

name    dept_num        salary  rank
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">0.0</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">0.1</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.2</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.2</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">0.4</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.5</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.5</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.7</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.7</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.9</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.9</span></code></pre>

<h4 id="1-3-6-使用ntile进行数据分片排名"><a href="#1-3-6-使用ntile进行数据分片排名" class="headerlink" title="1.3.6 使用ntile进行数据分片排名"></a>1.3.6 使用ntile进行数据分片排名</h4><pre><code class="hljs angelscript">SELECT
name,
dept_num as deptno,
salary,
ntile(<span class="hljs-number">4</span>) OVER(ORDER BY salary desc) as ntile
FROM employee;

name    deptno  salary  ntile
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">1</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">1</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">2</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">2</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">2</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">3</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">3</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">3</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4</span></code></pre>

<p><strong>尖叫提示</strong>：从 Hive v2.1.0开始, 支持在OVER语句里使用聚集函数，比如：</p>
<pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span>
  dept_num,
  row_number() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> dept_num <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">sum</span>(salary)) <span class="hljs-keyword">as</span> rk
<span class="hljs-keyword">FROM</span> employee
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_num;

dept_num        rk
1000    1
1001    1
1002    1</code></pre>

<h3 id="1-4-窗口分析函数"><a href="#1-4-窗口分析函数" class="headerlink" title="1.4 窗口分析函数"></a>1.4 窗口分析函数</h3><p>常用的分析函数主要包括：</p>
<ul>
<li><strong>cume_dist</strong></li>
</ul>
<p>如果按升序排列，则统计：小于等于当前值的行数/总行数(number of rows ≤ current row)/(total number of  rows）。如果是降序排列，则统计：大于等于当前值的行数/总行数。比如，统计小于等于当前工资的人数占总人数的比例 ，用于累计统计.</p>
<ul>
<li><strong>lead(value_expr[,offset[,default]])</strong></li>
</ul>
<p>用于统计窗口内往下第n行值。第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL.</p>
<ul>
<li><strong>lag(value_expr[,offset[,default]])</strong></li>
</ul>
<p>与lead相反，用于统计窗口内往上第n行值。第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL.</p>
<ul>
<li><strong>first_value</strong></li>
</ul>
<p>取分组内排序后，截止到当前行，第一个值</p>
<ul>
<li><strong>last_value</strong></li>
</ul>
<p>取分组内排序后，截止到当前行，最后一个值</p>
<h4 id="1-4-1-统计小于等于当前工资的人数占总人数的比例"><a href="#1-4-1-统计小于等于当前工资的人数占总人数的比例" class="headerlink" title="1.4.1 统计小于等于当前工资的人数占总人数的比例"></a>1.4.1 统计小于等于当前工资的人数占总人数的比例</h4><pre><code class="hljs angelscript">SELECT
 name,
 dept_num as deptno,
 salary,
 cume_dist() OVER (ORDER BY salary) as cume
FROM employee;

name    deptno  salary  cume
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.18181818181818182</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.18181818181818182</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.36363636363636365</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.36363636363636365</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.5454545454545454</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.5454545454545454</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">0.6363636363636364</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.8181818181818182</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.8181818181818182</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">0.9090909090909091</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1.0</span></code></pre>

<h4 id="1-4-2-统计大于等于当前工资的人数占总人数的比例"><a href="#1-4-2-统计大于等于当前工资的人数占总人数的比例" class="headerlink" title="1.4.2 统计大于等于当前工资的人数占总人数的比例"></a>1.4.2 统计大于等于当前工资的人数占总人数的比例</h4><pre><code class="hljs angelscript">SELECT
 name,
 dept_num as deptno,
 salary,
 cume_dist() OVER (ORDER BY salary desc) as cume
FROM employee;

name    deptno  salary  cume
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">0.09090909090909091</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">0.18181818181818182</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.36363636363636365</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">0.36363636363636365</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">0.45454545454545453</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.6363636363636364</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.6363636363636364</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.8181818181818182</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.8181818181818182</span>
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">1.0</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">1.0</span></code></pre>

<h4 id="1-4-3-按照部门统计小于等于当前工资的人数占部门总人数的比例"><a href="#1-4-3-按照部门统计小于等于当前工资的人数占部门总人数的比例" class="headerlink" title="1.4.3 按照部门统计小于等于当前工资的人数占部门总人数的比例"></a>1.4.3 按照部门统计小于等于当前工资的人数占部门总人数的比例</h4><pre><code class="hljs angelscript">SELECT
 name,
 dept_num as deptno,
 salary,
 cume_dist() OVER (PARTITION BY dept_num ORDER BY salary) as cume
FROM employee;

name    deptno  salary  cume
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.4</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">0.4</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.6</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.8</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">1.0</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">0.3333333333333333</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">0.6666666666666666</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">1.0</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">0.3333333333333333</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">0.6666666666666666</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">1.0</span></code></pre>

<h4 id="1-4-4-按部门分组，统计每个部门员工的工资以及大于等于该员工工资的下一个员工的工资"><a href="#1-4-4-按部门分组，统计每个部门员工的工资以及大于等于该员工工资的下一个员工的工资" class="headerlink" title="1.4.4 按部门分组，统计每个部门员工的工资以及大于等于该员工工资的下一个员工的工资"></a>1.4.4 按部门分组，统计每个部门员工的工资以及大于等于该员工工资的下一个员工的工资</h4><pre><code class="hljs yaml"><span class="hljs-string">SELECT</span>
 <span class="hljs-string">name,</span>
 <span class="hljs-string">dept_num</span> <span class="hljs-string">as</span> <span class="hljs-string">deptno,</span>
 <span class="hljs-string">salary,</span>
 <span class="hljs-string">lead(salary,1)</span> <span class="hljs-string">OVER</span> <span class="hljs-string">(PARTITION</span> <span class="hljs-string">BY</span> <span class="hljs-string">dept_num</span> <span class="hljs-string">ORDER</span> <span class="hljs-string">BY</span> <span class="hljs-string">salary)</span> <span class="hljs-string">as</span> <span class="hljs-string">lead</span>
<span class="hljs-string">FROM</span> <span class="hljs-string">employee;</span>

<span class="hljs-string">name</span>    <span class="hljs-string">deptno</span>  <span class="hljs-string">salary</span>  <span class="hljs-string">lead</span>
<span class="hljs-string">Wendy</span>   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4000</span>
<span class="hljs-string">Will</span>    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">5000</span>
<span class="hljs-string">Michael</span> <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">5500</span>
<span class="hljs-string">Lucy</span>    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">6400</span>
<span class="hljs-string">Steven</span>  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-literal">NULL</span>
<span class="hljs-string">Lily</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">6000</span>
<span class="hljs-string">Jess</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">6400</span>
<span class="hljs-string">Mike</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-literal">NULL</span>
<span class="hljs-string">Yun</span>     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">7000</span>
<span class="hljs-string">Wei</span>     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">8000</span>
<span class="hljs-string">Richard</span> <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-literal">NULL</span></code></pre>

<h4 id="1-4-5-按部门分组，统计每个部门员工的工资以及小于等于该员工工资的上一个员工的工资"><a href="#1-4-5-按部门分组，统计每个部门员工的工资以及小于等于该员工工资的上一个员工的工资" class="headerlink" title="1.4.5 按部门分组，统计每个部门员工的工资以及小于等于该员工工资的上一个员工的工资"></a>1.4.5 按部门分组，统计每个部门员工的工资以及小于等于该员工工资的上一个员工的工资</h4><pre><code class="hljs yaml"><span class="hljs-string">SELECT</span>
 <span class="hljs-string">name,</span>
 <span class="hljs-string">dept_num</span> <span class="hljs-string">as</span> <span class="hljs-string">deptno,</span>
 <span class="hljs-string">salary,</span>
 <span class="hljs-string">lag(salary,1)</span> <span class="hljs-string">OVER</span> <span class="hljs-string">(PARTITION</span> <span class="hljs-string">BY</span> <span class="hljs-string">dept_num</span> <span class="hljs-string">ORDER</span> <span class="hljs-string">BY</span> <span class="hljs-string">salary)</span> <span class="hljs-string">as</span> <span class="hljs-string">lead</span>
<span class="hljs-string">FROM</span> <span class="hljs-string">employee;</span>

<span class="hljs-string">name</span>    <span class="hljs-string">deptno</span>  <span class="hljs-string">salary</span>  <span class="hljs-string">lead</span>
<span class="hljs-string">Wendy</span>   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-literal">NULL</span>
<span class="hljs-string">Will</span>    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4000</span>
<span class="hljs-string">Michael</span> <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">4000</span>
<span class="hljs-string">Lucy</span>    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">5000</span>
<span class="hljs-string">Steven</span>  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">5500</span>
<span class="hljs-string">Lily</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-literal">NULL</span>
<span class="hljs-string">Jess</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">5000</span>
<span class="hljs-string">Mike</span>    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">6000</span>
<span class="hljs-string">Yun</span>     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-literal">NULL</span>
<span class="hljs-string">Wei</span>     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">5500</span>
<span class="hljs-string">Richard</span> <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">7000</span></code></pre>

<h4 id="1-4-6-按部门分组，统计每个部门员工工资以及该部门最低的员工工资"><a href="#1-4-6-按部门分组，统计每个部门员工工资以及该部门最低的员工工资" class="headerlink" title="1.4.6 按部门分组，统计每个部门员工工资以及该部门最低的员工工资"></a>1.4.6 按部门分组，统计每个部门员工工资以及该部门最低的员工工资</h4><pre><code class="hljs angelscript">SELECT
 name,
 dept_num as deptno,
 salary,
 first_value(salary) OVER (PARTITION BY dept_num ORDER BY salary) as fval
FROM employee;

name    deptno  salary  fval
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4000</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">4000</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">4000</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">4000</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">4000</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">5000</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">5000</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">5000</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">5500</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">5500</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">5500</span></code></pre>

<h4 id="1-4-7-按部门分组，统计每个部门员工工资以及该部门最高的员工工资"><a href="#1-4-7-按部门分组，统计每个部门员工工资以及该部门最高的员工工资" class="headerlink" title="1.4.7 按部门分组，统计每个部门员工工资以及该部门最高的员工工资"></a>1.4.7 按部门分组，统计每个部门员工工资以及该部门最高的员工工资</h4><pre><code class="hljs angelscript">SELECT
 name,
 dept_num as deptno,
 salary,
 last_value(salary) OVER (PARTITION BY dept_num ORDER BY salary RANGE
BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) as lval
FROM employee;

name    deptno  salary  lval
Wendy   <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">6400</span>
Will    <span class="hljs-number">1000</span>    <span class="hljs-number">4000</span>    <span class="hljs-number">6400</span>
Michael <span class="hljs-number">1000</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">6400</span>
Lucy    <span class="hljs-number">1000</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">6400</span>
Steven  <span class="hljs-number">1000</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">6400</span>
Lily    <span class="hljs-number">1001</span>    <span class="hljs-number">5000</span>    <span class="hljs-number">6400</span>
Jess    <span class="hljs-number">1001</span>    <span class="hljs-number">6000</span>    <span class="hljs-number">6400</span>
Mike    <span class="hljs-number">1001</span>    <span class="hljs-number">6400</span>    <span class="hljs-number">6400</span>
Yun     <span class="hljs-number">1002</span>    <span class="hljs-number">5500</span>    <span class="hljs-number">8000</span>
Wei     <span class="hljs-number">1002</span>    <span class="hljs-number">7000</span>    <span class="hljs-number">8000</span>
Richard <span class="hljs-number">1002</span>    <span class="hljs-number">8000</span>    <span class="hljs-number">8000</span></code></pre>

<p><strong>注意</strong>: last_value默认的窗口是RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT  ROW，表示当前行永远是最后一个值，需改成RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED  FOLLOWING。</p>
<p><img src="https://s1.ax1x.com/2020/08/20/d8xdVU.png" srcset="/img/loading.gif" alt=""></p>
<ul>
<li>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</li>
</ul>
<p>为默认值，即当指定了ORDER BY从句，而省略了window从句 ，表示从开始到当前行。</p>
<ul>
<li>RANGE BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING</li>
</ul>
<p>表示从当前行到最后一行</p>
<ul>
<li>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</li>
</ul>
<p>表示所有行</p>
<ul>
<li>n PRECEDING  m FOLLOWING</li>
</ul>
<p>表示窗口的范围是：[（当前行的行数）- n, （当前行的行数）+m] row.</p>
<h2 id="2-窗口函数——练习二"><a href="#2-窗口函数——练习二" class="headerlink" title="2. 窗口函数——练习二"></a>2. 窗口函数——练习二</h2><h3 id="2-1-数据准备"><a href="#2-1-数据准备" class="headerlink" title="2.1 数据准备"></a>2.1 数据准备</h3><h4 id="2-1-1-样例数据"><a href="#2-1-1-样例数据" class="headerlink" title="2.1.1 样例数据"></a>2.1.1 样例数据</h4><pre><code class="hljs angelscript">name，orderdate，cost
jack,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>,<span class="hljs-number">10</span>
tony,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>,<span class="hljs-number">15</span>
jack,<span class="hljs-number">2017</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>,<span class="hljs-number">23</span>
tony,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>,<span class="hljs-number">29</span>
jack,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>,<span class="hljs-number">46</span>
jack,<span class="hljs-number">2017</span><span class="hljs-number">-04</span><span class="hljs-number">-06</span>,<span class="hljs-number">42</span>
tony,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>,<span class="hljs-number">50</span>
jack,<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>,<span class="hljs-number">55</span>
mart,<span class="hljs-number">2017</span><span class="hljs-number">-04</span><span class="hljs-number">-08</span>,<span class="hljs-number">62</span>
mart,<span class="hljs-number">2017</span><span class="hljs-number">-04</span><span class="hljs-number">-09</span>,<span class="hljs-number">68</span>
neil,<span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-10</span>,<span class="hljs-number">12</span>
mart,<span class="hljs-number">2017</span><span class="hljs-number">-04</span><span class="hljs-number">-11</span>,<span class="hljs-number">75</span>
neil,<span class="hljs-number">2017</span><span class="hljs-number">-06</span><span class="hljs-number">-12</span>,<span class="hljs-number">80</span>
mart,<span class="hljs-number">2017</span><span class="hljs-number">-04</span><span class="hljs-number">-13</span>,<span class="hljs-number">94</span></code></pre>

<h4 id="2-1-2-建表语句"><a href="#2-1-2-建表语句" class="headerlink" title="2.1.2 建表语句"></a>2.1.2 建表语句</h4><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> business(
<span class="hljs-keyword">name</span> <span class="hljs-keyword">string</span>, 
orderdate <span class="hljs-keyword">string</span>,
<span class="hljs-keyword">cost</span> <span class="hljs-built_in">int</span>
) <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> <span class="hljs-keyword">DELIMITED</span> <span class="hljs-keyword">FIELDS</span> <span class="hljs-keyword">TERMINATED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">','</span>;</code></pre>

<h4 id="2-1-3-导入数据"><a href="#2-1-3-导入数据" class="headerlink" title="2.1.3 导入数据"></a>2.1.3 导入数据</h4><pre><code class="hljs sql"><span class="hljs-keyword">load</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">local</span> inpath <span class="hljs-string">"/opt/module/datas/business.txt"</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> business;</code></pre>

<h3 id="2-2-相关说明"><a href="#2-2-相关说明" class="headerlink" title="2.2 相关说明"></a>2.2 相关说明</h3><p>OVER()：指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化</p>
<p>CURRENT ROW：当前行</p>
<p>n PRECEDING：往前n行数据</p>
<p>n FOLLOWING：往后n行数据</p>
<p>UNBOUNDED：起点，UNBOUNDED PRECEDING 表示从前面的起点， UNBOUNDED FOLLOWING表示到后面的终点</p>
<p>LAG(col,n)：往前第n行数据</p>
<p>LEAD(col,n)：往后第n行数据</p>
<p>NTILE(n)：把有序分区中的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。注意：n必须为int类型。</p>
<h3 id="2-3-练习题"><a href="#2-3-练习题" class="headerlink" title="2.3 练习题"></a>2.3 练习题</h3><h4 id="2-3-1-查询在2017年4月份购买过的顾客及总人数"><a href="#2-3-1-查询在2017年4月份购买过的顾客及总人数" class="headerlink" title="2.3.1 查询在2017年4月份购买过的顾客及总人数"></a>2.3.1 查询在2017年4月份购买过的顾客及总人数</h4><pre><code class="hljs routeros">select name,count(*) over () 
<span class="hljs-keyword">from</span> business 
where substring(orderdate,1,7) = <span class="hljs-string">'2017-04'</span> 
group by name;</code></pre>

<h4 id="2-3-2-查询顾客的购买明细及月购买总额"><a href="#2-3-2-查询顾客的购买明细及月购买总额" class="headerlink" title="2.3.2 查询顾客的购买明细及月购买总额"></a>2.3.2 查询顾客的购买明细及月购买总额</h4><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">name</span>,orderdate,<span class="hljs-keyword">cost</span>,<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">month</span>(orderdate)) <span class="hljs-keyword">from</span>
 business;</code></pre>

<h4 id="2-3-3-上述的场景-要将cost按照日期进行累加"><a href="#2-3-3-上述的场景-要将cost按照日期进行累加" class="headerlink" title="2.3.3 上述的场景,要将cost按照日期进行累加"></a>2.3.3 上述的场景,要将cost按照日期进行累加</h4><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">name</span>,orderdate,<span class="hljs-keyword">cost</span>, 
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>() <span class="hljs-keyword">as</span> sample1,<span class="hljs-comment">--所有行相加 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span>) <span class="hljs-keyword">as</span> sample2,<span class="hljs-comment">--按name分组，组内数据相加 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate) <span class="hljs-keyword">as</span> sample3,<span class="hljs-comment">--按name分组，组内数据累加 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate <span class="hljs-keyword">rows</span> <span class="hljs-keyword">between</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">current</span> <span class="hljs-keyword">row</span> ) <span class="hljs-keyword">as</span> sample4 ,<span class="hljs-comment">--和sample3一样,由起点到当前行的聚合 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate <span class="hljs-keyword">rows</span> <span class="hljs-keyword">between</span> <span class="hljs-number">1</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">current</span> <span class="hljs-keyword">row</span>) <span class="hljs-keyword">as</span> sample5, <span class="hljs-comment">--当前行和前面一行做聚合 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate <span class="hljs-keyword">rows</span> <span class="hljs-keyword">between</span> <span class="hljs-number">1</span> <span class="hljs-keyword">PRECEDING</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOLLOWING</span> ) <span class="hljs-keyword">as</span> sample6,<span class="hljs-comment">--当前行和前边一行及后面一行 </span>
<span class="hljs-keyword">sum</span>(<span class="hljs-keyword">cost</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate <span class="hljs-keyword">rows</span> <span class="hljs-keyword">between</span> <span class="hljs-keyword">current</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">UNBOUNDED</span> <span class="hljs-keyword">FOLLOWING</span> ) <span class="hljs-keyword">as</span> sample7 <span class="hljs-comment">--当前行及后面所有行 </span>
<span class="hljs-keyword">from</span> business;</code></pre>

<h4 id="2-3-4-查看顾客上次的购买时间"><a href="#2-3-4-查看顾客上次的购买时间" class="headerlink" title="2.3.4 查看顾客上次的购买时间"></a>2.3.4 查看顾客上次的购买时间</h4><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> <span class="hljs-type">name</span>,orderdate,<span class="hljs-keyword">cost</span>, 
lag(orderdate,<span class="hljs-number">1</span>,<span class="hljs-string">'1900-01-01'</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-type">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate ) <span class="hljs-keyword">as</span> time1, lag(orderdate,<span class="hljs-number">2</span>) <span class="hljs-keyword">over</span> (<span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> <span class="hljs-type">name</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate) <span class="hljs-keyword">as</span> time2 
<span class="hljs-keyword">from</span> business;</code></pre>

<h4 id="2-3-5-查询前20-时间的订单信息"><a href="#2-3-5-查询前20-时间的订单信息" class="headerlink" title="2.3.5 查询前20%时间的订单信息"></a>2.3.5 查询前20%时间的订单信息</h4><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> (
    <span class="hljs-keyword">select</span> <span class="hljs-type">name</span>,orderdate,<span class="hljs-keyword">cost</span>, ntile(<span class="hljs-number">5</span>) <span class="hljs-keyword">over</span>(<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> orderdate) sorted
    <span class="hljs-keyword">from</span> business
) t
<span class="hljs-keyword">where</span> sorted = <span class="hljs-number">1</span>;</code></pre>



<blockquote>
<p>参考资料：</p>
<p><a href="https://mp.weixin.qq.com/s/K2TA_PhNzGEkucYxBXqhLw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/K2TA_PhNzGEkucYxBXqhLw</a></p>
</blockquote>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Hive/">Hive</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Hive/">Hive</a>
                    
                      <a class="hover-with-bg" href="/tags/%E7%BB%83%E4%B9%A0%E9%A2%98/">练习题</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/21/Hive%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%88%E4%BA%8C%EF%BC%89/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Hive常用函数（二）</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/04/Spark%E5%AE%9A%E4%B9%89UDF%E5%87%BD%E6%95%B0%EF%BC%8CUDAF%E5%87%BD%E6%95%B0/">
                        <span class="hidden-mobile">Spark定义UDF函数，UDAF函数</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
